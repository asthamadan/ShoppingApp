name : Build new app-ShoppingApp
on:
   workflow_dispatch:
jobs:
  job1:
   runs-on: ubuntu-latest
   steps:
       - name: clone the repo
         uses: actions/checkout@v4
       - name: Install nodejs
         uses: actions/setup-node@v4
         with:
           node-version: '18'
           cache: 'npm'

       - name: Install dependencies
         run: npm ci

       - name: Show available scripts (for debugging)
         run: npm run

       - name: Execute test cases
         run: npm test

       - name: Set up Docker Buildx
         uses: docker/setup-buildx-action@v3

       - name: Log in to Docker Hub
         uses: docker/login-action@v3
         with:
          username: amadan783
          password: ${{ secrets.DOCKERHUB_TOKEN }}

       - name: Extract metadata (tags, labels) for Docker
         id: meta
         uses: docker/metadata-action@v5
         with:
          images: amadan783/myapp
          tags: |
            type=raw,value=develop-${{ github.run_number }},enable=${{ github.ref == 'refs/heads/develop' }}
            type=raw,value=main-${{ github.run_number }},enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

       - name: Build and push Docker image
         uses: docker/build-push-action@v5
         with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

       - name: Verify push
         run: |
          docker pull amadan783/myapp:develop-${{ github.run_number }} || docker pull amadan783/myapp:main-${{ github.run_number }} || docker pull amadan783/myapp:latest
          echo "Image pulled successfully"
       
